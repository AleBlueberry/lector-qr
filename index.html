<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prueba Lector QR</title>
  <style>
    :root{--accent:#1976d2;--bg:#f7f9fc}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;background:var(--bg);color:#111}
    header{width:100%;display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0}
    video{width:100%;max-width:720px;height:auto;border-radius:12px;background:#000;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
    #status{font-weight:600}
    #result{font-size:16px;padding:10px;border-radius:10px;background:#fff;border:1px solid #e6e9ee;max-width:720px;width:100%;word-break:break-word}
    .small{font-size:13px;color:#555}
    footer{font-size:12px;color:#666;margin-top:6px}
    .hint{background:#fff;padding:8px;border-radius:10px;border:1px dashed #dbe4f0;max-width:720px;width:100%;text-align:center}
  </style>
</head>
<body>
  <header>
    <div style="width:38px;height:38px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">QR</div>
    <div>
      <h1>Prueba Lector QR</h1>
      <div class="small">Permite cámara y apunta al código QR</div>
    </div>
  </header>

  <video id="video" autoplay playsinline></video>
  <div id="status">Iniciando cámara…</div>

  <div id="result" aria-live="polite">Resultado: <span id="code">—</span></div>

  <div class="hint small">Si no aparece la cámara en iPhone: usa Safari y permite "Usar Cámara" en los permisos.</div>

  <footer>Versión de prueba — solo muestra el texto del QR</footer>

  <!-- biblioteca jsQR -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const codeEl = document.getElementById('code');

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        status.textContent = 'Apunta al QR';
        requestAnimationFrame(tick);
      } catch (err) {
        status.textContent = 'Error al acceder a la cámara: ' + (err.message || err);
      }
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    let last = null;
    let cooldown = false;

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const qr = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "attemptBoth" });
        if (qr && qr.data) {
          const text = qr.data.trim();
          if (!cooldown || text !== last) {
            last = text;
            cooldown = true;
            status.textContent = 'QR detectado';
            codeEl.textContent = text;
            // pequeño vibrate (si el dispositivo lo permite)
            if (navigator.vibrate) navigator.vibrate(100);
            setTimeout(()=> cooldown = false, 1000); // evita repetidos rápidos
          }
        }
      }
      requestAnimationFrame(tick);
    }

    // iniciar al cargar la página
    startCamera();
  </script>
</body>
</html>
